const User = require('../models/userSchema');
const bcrypt = require('bcrypt');
const nodemailer = require('nodemailer');
const env = require('dotenv').config();

const pagenotfound = async (req, res) => {
  res.status(404).render('notfound', { title: 'Page Not Found' });
};

// Load homepage function
const loadHomePage = async (req, res) => {
  try {
    // Any logic for homepage rendering, like fetching data, can go here
    res.render('home');
    // res.render('index', { title: 'Welcome to Our eCommerce Site' });
  } catch (error) {
    console.error('Error loading homepage:', error);
    res.status(500).send('Server error while loading homepage');
  }
};

const loadSignup = async (req, res) => {
  try {
    res.render('signup', { message: null });
  } catch (err) {
    console.log('error in signingup ', err);
    res.status(500).send('Server Error');
  }
};


function generateOtp() {
  return Math.floor(100000 + Math.random()* 900000).toString()
}

async function sendVerificationEmail(email, otp) {
  try {
    let transporter = nodemailer.createTransport({
      service: 'gmail',
      port: 587,
      secure: false,
      require: true,
      auth: {
        user:process.env.NODEMAILER_EMAIL,
        pass:process.env.NODEMAILER_PASSWORD
      }
    })
  
    
    const info = await transporter.sendMail({
      from: process.env.NODEMAILER_EMAIL,
      to: email,
      subject: "Verify your account",
      text:`Your OTP is ${otp}`,
      html:`<b>Your otp is ${otp}</b>`, 
    })

    return info.accepted.length >0
  }
  catch (err) {
    console.error("Error sending email", err)
    return false;
  }
  
}

const signup = async (req, res) => {
  const name = req.body.name.trim();
  const email = req.body.email.trim();
  const password = req.body.password.trim();
  const confirmPassword = req.body.confirmPassword.trim();

  //Input validation
  if (!name || !email || !password || !confirmPassword) {
    return res.render('signup', { message: 'All fields are required' });
  }

  //name validation
  const nameRegex = /^[a-zA-Z\s]{2,30}$/;
  if (!name || !nameRegex.test(name)) {
    return res.render('signup', {
      message: 'Name must contain only letters and spaces (2-30 characters).',
    });
  }

  // Email validation
  const emailRegex = /.+\@.+\..+/;
  if (!emailRegex.test(email)) {
    return res.render('signup', {
      message: 'Please enter a valid email address',
    });
  }

  //password check
  if (password !== confirmPassword) {
    return res.render('signup', { message: 'Passwords do not match' });
  }

  // Check if user already exists
  try {
    const existingUser = await User.findOne({ email });
    if (existingUser) {
      return res.render('signup', { message: 'Email is already registered' });
    }

    const otp = generateOtp();
    const emailSent = await sendVerificationEmail(email, otp)
    if (!emailSent) {
      return res.json("email-error")
    }

    req.session.userOtp=otp
    req.session.userData = { name,email, password }
    
    res.render("verifyOtp", { message: null });
    console.log("OTP sent:",otp)

  } catch (err) {
    console.error('Error in user signup:', err);
    res.status(500).send('Server Error');
  }
};

const verifyOtp = async (req, res) => {
  const { otp } = req.body;

  // Check if OTP matches
  if (otp !== req.session.userOtp) {
    return res.render('verifyOtp', { message: 'Invalid OTP. Please try again.' });
  }

  // If OTP matches, hash the password and save the user
  try {
    const { name, email, password } = req.session.userData;
    const salt = await bcrypt.genSalt(10);
    const hashedPassword = await bcrypt.hash(password, salt);

    const newUser = new User({ name, email, password: hashedPassword });
    await newUser.save();

    // Clear OTP and session data after successful registration
    req.session.userOtp = null;
    req.session.userData = null;

    return res.redirect('/signin');
  } catch (err) {
    console.error('Error verifying OTP:', err);
    res.status(500).send('Server Error');
  }
};


const loadSignin = async (req, res) => {
  try {
    res.render('signin', { message: null });
  } catch (err) {
    console.log('error in signingup ', err);
    res.status(500).send('Server Error');
  }
};

// const signin = async (req, res) => {
//   const { name, email, password } = req.body;
//   try {
//     const existingUser = await User.findOne({ email });
//     if (existingUser) {
//       return res.redirect('/');
//     }
//   }
//   catch (err) {
//     console.log('error in signingup ', err)
//     res.status(500).send('Server Error')
//   }

// }

module.exports = {
  loadHomePage,
  loadSignup,
  loadSignin,
  signup,
  verifyOtp,
  // signin,
  pagenotfound,
};
